# Copyright 2017 The WWU eLectures Team All rights reserved.
#
# Licensed under the Educational Community License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License. You may obtain a copy of the License at
#
#     http://opensource.org/licenses/ECL-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
variables:
  ELE_VERSION:      "3.4"
  ELE_VERSION_FULL: "3.4_wwu.x"

stages:
  - info
  - build
  - release
  - trigger

info:
  stage: info
  image: maven:3.5
  script:
    - java -version
    - javac -version
    - mvn --version

build:
  stage: build
  image: maven:3.5
  script:
    - mvn install --batch-mode -Dopencast.version="${ELE_VERSION}"
  artifacts:
    expire_in: 1 week
    paths:
      - opencast-userdirectory-moodle/target/opencast-userdirectory-moodle-*.jar

release-master:
  stage: release
  only:
    - master
  script:
    - mkdir deploy
    - cd deploy
    - cp ../opencast-userdirectory-moodle/target/opencast-userdirectory-moodle-*.jar .
    - ele-release-push master opencast-userdirectory-moodle-*.jar

release-release:
  stage: release
  only:
    - tags
  script:
    - mkdir deploy
    - cd deploy
    - cp ../opencast-userdirectory-moodle/target/opencast-userdirectory-moodle-*.jar .
    - ele-release-push latest opencast-userdirectory-moodle-*.jar
    - ele-release-push "${ELE_VERSION}" opencast-userdirectory-moodle-*.jar
    - ele-release-push "${ELE_VERSION_FULL}" opencast-userdirectory-moodle-*.jar

trigger-master:
  stage: trigger
  only:
    - master
  script:
    - ele-trigger-build electures/opencast/opencast-docker
        "ref=master"
        "OC_USERDIRECTORY_MOODLE_RELEASE=master"

trigger-release:
  stage: trigger
  when: manual
  only:
    - tags
  script:
    - ele-trigger-build electures/opencast/opencast-docker
        "ref=${ELE_VERSION_FULL}"
        "OC_USERDIRECTORY_MOODLE_RELEASE=${ELE_VERSION_FULL}"
